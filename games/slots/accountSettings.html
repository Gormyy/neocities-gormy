<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings</title>
  <link rel="stylesheet" href="../../resources/css/slotStyle.css">
  <script src = "../../resources/js/utils/addNavigation.js">//adds addNavidation(div, pathToRoot = "", centered = true, style = "default", navigationElements = "default") to add the navigation to the div bar</script>
</head>

<body>
  <br><br><br>
  <div id="wrapper">
    <div id="navigationwrap">
      <div id="navigation">

      </div>
      <script>
          //script to add navigation elements
          let div = document.getElementById("navigation")
          addNavigation(div, "../../", true, "default", "slots")
      </script>
    </div>

    <div id="contentwrap">
      <div id="content">
        <center>
          <button class="rounded-btn" id="changeUsername" onclick="changeUsername()">Change Username</button><span>
          </span><label> Username: </label><input type="text" id="changeUsernameInput"></input>
        </center>
      </div>

      <div id="content">
        <center>
          <button class="rounded-btn" id="changeUsername" onclick="changePassword()">Change Password</button><span>
          </span><label> Password: </label><input type="password" id="changePasswordInput"></input>
        </center>
      </div>

      <div id="content">
        <center>
          <button class="rounded-btn" id="changeUsername" onclick="login()">Login</button><br><br>

          </span> <label> Username: </label><input type="text" id="loginUsernameInput"></input> <span> </span><label>
            Password: </label><input type="password" id="loginPasswordInput"></input>
        </center>
      </div>

    </div>



    <div id="footerwrap">
      <div id="footer">

        <center>
          <p id="messages">Please don't lose your password I don't really have a good way to get your account back if
            you do.</p>
        </center>
      </div>
    </div>

    <div id="footerwrap">
      <div id="footer">
        <center>
          <p id="userInfo"><strong>Logged in as: </strong><span id="user"></span> <strong>Balance: </strong><span
              id="bal"></span></p>
        </center>
      </div>
    </div>

    <div id="footerwrap">
      <div id="footer">

        <script>
          const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
          };

          const setCookie = (name, value, days = 365) => {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/`;
          };

          async function autoLogin() {

            let username = getCookie("name");
            let hashedPassword = getCookie("hashedpassword");

            let url;
            if (username && hashedPassword) {
              url = `https://gormysecret.onrender.com/login?username=${encodeURIComponent(username)}&password=${encodeURIComponent(hashedPassword)}&loginType=hash`;
            } else {
              url = `https://gormysecret.onrender.com/login`;
            }

            try {
              const response = await fetch(url);
              if (!response.ok) throw new Error("Login failed");

              const data = await response.json();
              console.log(data)
              // Save name and generated password if it's a new login
              if (!username || !hashedPassword) {
                setCookie("name", data.name);
                setCookie("hashedpassword", data.generatedPassword);
              }

              console.log("Logged in as:", data.name);

              //user and bal elements
              let uEl = document.getElementById("user")
              let balEl = document.getElementById("bal")

              uEl.innerHTML = data.name
              balEl.innerHTML = Math.round(data.balance * 100) / 100

              // You can now use the user data
            } catch (err) {
              console.error("Auto-login failed:", err);
            }
          }

          window.addEventListener("load", autoLogin);

          async function changeUsername() {
            let username = getCookie("name");
            let hashedPassword = getCookie("hashedpassword");
            const input = document.getElementById("changeUsernameInput").value.trim()
            const messages = document.getElementById("messages")
            if (input === "") {
              messages.innerHTML = "Username cannot be empty"
              return
            }

            url = `https://gormysecret.onrender.com/changeUsername?username=${encodeURIComponent(username)}&hashedPassword=${encodeURIComponent(hashedPassword)}&newname=${encodeURIComponent(input)}`;
            //console.log(url)
            const response = await fetch(url);
            if (!response.ok) {
              messages.innerHTML = "Username is already taken"
              return
            }

            const data = await response.json();
            console.log(data)
            setCookie("name", input);
            messages.innerHTML = "Username changed succesfully"
            autoLogin()
            console.log(data)
          }

          async function changePassword() {
            let username = getCookie("name");
            let hashedPassword = getCookie("hashedpassword");
            const input = document.getElementById("changePasswordInput").value.trim()
            const messages = document.getElementById("messages")
            if (input === "") {
              messages.innerHTML = "Password cannot be empty"
              return
            }

            url = `https://gormysecret.onrender.com/changePassword?username=${encodeURIComponent(username)}&hashedPassword=${encodeURIComponent(hashedPassword)}&newpassword=${encodeURIComponent(input)}`;
            //console.log(url)
            const response = await fetch(url);
            if (!response.ok) {
              messages.innerHTML = "Error changing password"
              return
            }

            const data = await response.json();

            setCookie("hashedpassword", data.generatedPassword);
            messages.innerHTML = "Password changed succesfully"
            autoLogin()
            console.log(data)
          }

          async function login() {
            const usernameInput = document.getElementById("loginUsernameInput").value.trim()
            const passwordInput = document.getElementById("loginPasswordInput").value.trim()
            const messages = document.getElementById("messages")

            if (usernameInput === "" || passwordInput === "") {
              messages.innerHTML = "Username/password cannot be empty"
              return
            }

            let url = `https://gormysecret.onrender.com/login?username=${encodeURIComponent(usernameInput)}&password=${encodeURIComponent(passwordInput)}`;

            const response = await fetch(url);

            if (!response.ok) {
              messages.innerHTML = "Error logging in"
              return
            }
            const data = await response.json()

            setCookie("name", data.name);
            setCookie("hashedpassword", data.generatedPassword);

            messages.innerHTML = "Logged in succesfully"
            autoLogin()
          }
        </script>


        Layout: <a href="http://itinerae.neocities.org" target="_blank">Itinerae</a> Pixels: <a
          href="https://foollovers.com/" target="_blank">Fool Lovers</a> Lace border: <a
          href="https://pastebin.com/1s0bztqb" target="_blank">Loveberry</a> Sylveon sprite: <a
          href="https://www.deviantart.com/retronc/art/Sylveon-Animated-Sprite-977536346">RetroNC</a>
      </div>
    </div>
  </div>

  <script>
    const eeveelutions = {
      "Vaporeon": "https://64.media.tumblr.com/5d1ac86900a33c913bbc4cee690e8ef4/5b687adaf1b0cff0-8d/s250x400/5907611d50bf7d0892fbd933163939239f8fdfa9.gifv",
      "Glaceon": "https://img.pokemondb.net/sprites/black-white/anim/normal/glaceon.gif",
      "Flareon": "https://img.pokemondb.net/sprites/black-white/anim/normal/flareon.gif",
      "Jolteon": "https://img.pokemondb.net/sprites/black-white/anim/normal/jolteon.gif",
      "Espeon": "https://img.pokemondb.net/sprites/black-white/anim/normal/espeon.gif",
      "Umbreon": "https://img.pokemondb.net/sprites/black-white/anim/normal/umbreon.gif",
      "Leafeon": "https://img.pokemondb.net/sprites/black-white/anim/normal/leafeon.gif",
      "Eevee": "https://img.pokemondb.net/sprites/black-white/anim/normal/eevee.gif",
      "Sylveon": "https://i.postimg.cc/GpMXpMjD/dg5zzve-0a3e38cd-c3c7-4290-aed5-f4bb01860b0a.gif",
      "Shiny Eevee": "https://img.pokemondb.net/sprites/black-white/anim/shiny/eevee.gif"
    };

    /*
    async function fetchSpinData() {
      const res = await fetch('https://gormysecret.onrender.com/luckValues');
      const data = await res.json();
    return data;
    }
    */
  </script>
</body>

</html>